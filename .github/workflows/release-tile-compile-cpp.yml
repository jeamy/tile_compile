name: Release tile_compile_cpp

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g. v1.2.3)'
        required: true

permissions:
  contents: write

jobs:
  build-linux-macos:
    name: Build + Package (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve release tag
        id: tag
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${GITHUB_REF_NAME}"
          fi
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake ninja-build pkg-config \
            libeigen3-dev libopencv-dev libcfitsio-dev libyaml-cpp-dev nlohmann-json3-dev libssl-dev \
            qt6-base-dev qt6-tools-dev

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install cmake ninja pkg-config eigen opencv cfitsio yaml-cpp nlohmann-json openssl qt
          echo "CMAKE_PREFIX_PATH=$(brew --prefix qt):$(brew --prefix openssl)" >> "$GITHUB_ENV"

      - name: Configure
        run: cmake -S tile_compile_cpp -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=OFF

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Package with runtime dependencies (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.tag.outputs.tag }}"
          PKG="tile_compile_cpp-linux-${TAG}"
          mkdir -p "$PKG"/{bin,lib,gui_cpp,plugins}

          cp -f build/tile_compile_runner "$PKG/bin/"
          cp -f build/tile_compile_cli "$PKG/bin/"
          cp -f build/tile_compile_gui "$PKG/bin/"
          cp -f tile_compile_cpp/tile_compile.yaml "$PKG/"
          cp -f tile_compile_cpp/tile_compile.schema.yaml "$PKG/"
          cp -f tile_compile_cpp/tile_compile.schema.json "$PKG/"
          cp -f tile_compile_cpp/gui_cpp/constants.js "$PKG/gui_cpp/"
          cp -f tile_compile_cpp/gui_cpp/styles.qss "$PKG/gui_cpp/"

          collect_deps_recursive() {
            local target="$1"
            ldd "$target" | awk '/=> \/|^\// {for (i=1;i<=NF;i++) if ($i ~ /^\//) print $i}' | while read -r dep; do
              [[ -f "$dep" ]] || continue
              local base copied
              base=$(basename "$dep")
              copied="$PKG/lib/$base"
              if [[ ! -f "$copied" ]]; then
                cp -L "$dep" "$copied"
                collect_deps_recursive "$copied"
              fi
            done
          }

          collect_deps_recursive "$PKG/bin/tile_compile_runner"
          collect_deps_recursive "$PKG/bin/tile_compile_cli"
          collect_deps_recursive "$PKG/bin/tile_compile_gui"

          # Prefer Qt6 tool, fallback to qtpaths if needed
          QTPATHS_BIN=$(command -v qtpaths6 || command -v qtpaths)
          QT_PLUGIN_DIR=$($QTPATHS_BIN --plugin-dir)
          for subdir in platforms imageformats iconengines styles; do
            if [[ -d "$QT_PLUGIN_DIR/$subdir" ]]; then
              mkdir -p "$PKG/plugins/$subdir"
              cp -a "$QT_PLUGIN_DIR/$subdir/." "$PKG/plugins/$subdir/"
            fi
          done

          cat > "$PKG/bin/run_tile_compile_gui.sh" <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail
          DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          ROOT="$(cd "$DIR/.." && pwd)"
          export LD_LIBRARY_PATH="$ROOT/lib:${LD_LIBRARY_PATH:-}"
          export QT_PLUGIN_PATH="$ROOT/plugins"
          exec "$DIR/tile_compile_gui" "$@"
          EOF
          chmod +x "$PKG/bin/run_tile_compile_gui.sh"

          LD_LIBRARY_PATH="$PKG/lib" ldd "$PKG/bin/tile_compile_runner" | tee "$PKG/ldd_runner.txt"
          LD_LIBRARY_PATH="$PKG/lib" ldd "$PKG/bin/tile_compile_cli" | tee "$PKG/ldd_cli.txt"
          LD_LIBRARY_PATH="$PKG/lib" ldd "$PKG/bin/tile_compile_gui" | tee "$PKG/ldd_gui.txt"
          ! grep -q "not found" "$PKG/ldd_runner.txt"
          ! grep -q "not found" "$PKG/ldd_cli.txt"
          ! grep -q "not found" "$PKG/ldd_gui.txt"

          tar -czf "${PKG}.tar.gz" "$PKG"

      - name: Upload package (Linux)
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: tile_compile_cpp-linux-${{ steps.tag.outputs.tag }}
          path: tile_compile_cpp-linux-${{ steps.tag.outputs.tag }}.tar.gz

      - name: Package with runtime dependencies (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.tag.outputs.tag }}"
          PKG="tile_compile_cpp-macos-${TAG}"
          mkdir -p "$PKG"/{bin,lib,gui_cpp,plugins}

          cp -f build/tile_compile_runner "$PKG/bin/"
          cp -f build/tile_compile_cli "$PKG/bin/"
          cp -f build/tile_compile_gui "$PKG/bin/"
          cp -f tile_compile_cpp/tile_compile.yaml "$PKG/"
          cp -f tile_compile_cpp/tile_compile.schema.yaml "$PKG/"
          cp -f tile_compile_cpp/tile_compile.schema.json "$PKG/"
          cp -f tile_compile_cpp/gui_cpp/constants.js "$PKG/gui_cpp/"
          cp -f tile_compile_cpp/gui_cpp/styles.qss "$PKG/gui_cpp/"

          collect_deps_recursive() {
            local target="$1"
            otool -L "$target" | tail -n +2 | awk '{print $1}' | while read -r dep; do
              [[ "$dep" == /usr/lib/* ]] && continue
              [[ "$dep" == /System/* ]] && continue
              [[ -f "$dep" ]] || continue
              local base copied
              base=$(basename "$dep")
              copied="$PKG/lib/$base"
              if [[ ! -f "$copied" ]]; then
                cp -L "$dep" "$copied"
                collect_deps_recursive "$copied"
              fi
            done
          }

          collect_deps_recursive "$PKG/bin/tile_compile_runner"
          collect_deps_recursive "$PKG/bin/tile_compile_cli"
          collect_deps_recursive "$PKG/bin/tile_compile_gui"

          # Prefer Qt6 tool, fallback to qtpaths if needed
          QTPATHS_BIN=$(command -v qtpaths6 || command -v qtpaths)
          QT_PLUGIN_DIR=$($QTPATHS_BIN --plugin-dir)
          for subdir in platforms imageformats iconengines styles; do
            if [[ -d "$QT_PLUGIN_DIR/$subdir" ]]; then
              mkdir -p "$PKG/plugins/$subdir"
              cp -a "$QT_PLUGIN_DIR/$subdir/." "$PKG/plugins/$subdir/"
            fi
          done

          cat > "$PKG/bin/run_tile_compile_gui.sh" <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail
          DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          ROOT="$(cd "$DIR/.." && pwd)"
          export DYLD_LIBRARY_PATH="$ROOT/lib:${DYLD_LIBRARY_PATH:-}"
          export QT_PLUGIN_PATH="$ROOT/plugins"
          exec "$DIR/tile_compile_gui" "$@"
          EOF
          chmod +x "$PKG/bin/run_tile_compile_gui.sh"

          DYLD_LIBRARY_PATH="$PKG/lib" otool -L "$PKG/bin/tile_compile_runner" | tee "$PKG/otool_runner.txt"
          DYLD_LIBRARY_PATH="$PKG/lib" otool -L "$PKG/bin/tile_compile_cli" | tee "$PKG/otool_cli.txt"
          DYLD_LIBRARY_PATH="$PKG/lib" otool -L "$PKG/bin/tile_compile_gui" | tee "$PKG/otool_gui.txt"

          zip -r "${PKG}.zip" "$PKG"

      - name: Upload package (macOS)
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: tile_compile_cpp-macos-${{ steps.tag.outputs.tag }}
          path: tile_compile_cpp-macos-${{ steps.tag.outputs.tag }}.zip

  build-windows:
    name: Build + Package (windows-latest / MSYS2)
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve release tag
        id: tag
        shell: pwsh
        run: |
          if ('${{ github.event_name }}' -eq 'workflow_dispatch') {
            $tag = '${{ github.event.inputs.tag }}'
          } else {
            $tag = '${{ github.ref_name }}'
          }
          "tag=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-pkgconf
            mingw-w64-x86_64-eigen3
            mingw-w64-x86_64-opencv
            mingw-w64-x86_64-cfitsio
            mingw-w64-x86_64-yaml-cpp
            mingw-w64-x86_64-nlohmann-json
            mingw-w64-x86_64-openssl
            mingw-w64-x86_64-qt6-base
            mingw-w64-x86_64-qt6-tools
            mingw-w64-x86_64-ntldd

      - name: Configure (MSYS2)
        shell: msys2 {0}
        run: cmake -S tile_compile_cpp -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=OFF

      - name: Build (MSYS2)
        shell: msys2 {0}
        run: cmake --build build --config Release --parallel

      - name: Package with runtime dependencies (Windows)
        shell: msys2 {0}
        run: |
          set -euo pipefail
          TAG='${{ steps.tag.outputs.tag }}'
          PKG="tile_compile_cpp-windows-${TAG}"
          mkdir -p "$PKG"/{gui_cpp,plugins,bin}

          cp -f build/tile_compile_runner.exe "$PKG/bin/"
          cp -f build/tile_compile_cli.exe "$PKG/bin/"
          cp -f build/tile_compile_gui.exe "$PKG/bin/"
          cp -f tile_compile_cpp/tile_compile.yaml "$PKG/"
          cp -f tile_compile_cpp/tile_compile.schema.yaml "$PKG/"
          cp -f tile_compile_cpp/tile_compile.schema.json "$PKG/"
          cp -f tile_compile_cpp/gui_cpp/constants.js "$PKG/gui_cpp/"
          cp -f tile_compile_cpp/gui_cpp/styles.qss "$PKG/gui_cpp/"

          collect_deps_recursive() {
            local target="$1"
            ldd "$target" | awk '/=> \/|^\// {for (i=1;i<=NF;i++) if ($i ~ /^\//) print $i}' | while read -r dep; do
              [[ -f "$dep" ]] || continue
              case "$dep" in
                /c/Windows/*) continue ;;
              esac
              local base copied
              base=$(basename "$dep")
              copied="$PKG/bin/$base"
              if [[ ! -f "$copied" ]]; then
                cp -L "$dep" "$copied"
                collect_deps_recursive "$copied"
              fi
            done
          }

          collect_deps_recursive "$PKG/bin/tile_compile_runner.exe"
          collect_deps_recursive "$PKG/bin/tile_compile_cli.exe"
          collect_deps_recursive "$PKG/bin/tile_compile_gui.exe"

          if command -v windeployqt6 >/dev/null 2>&1; then
            windeployqt6 --no-translations --no-opengl-sw --dir "$PKG/bin" "$PKG/bin/tile_compile_gui.exe"
          elif command -v windeployqt >/dev/null 2>&1; then
            windeployqt --no-translations --no-opengl-sw --dir "$PKG/bin" "$PKG/bin/tile_compile_gui.exe"
          fi

          # Prefer Qt6 tool, fallback to qtpaths if needed
          QTPATHS_BIN=$(command -v qtpaths6 || command -v qtpaths)
          QT_PLUGIN_DIR=$($QTPATHS_BIN --plugin-dir)
          for subdir in platforms imageformats iconengines styles; do
            if [[ -d "$QT_PLUGIN_DIR/$subdir" ]]; then
              mkdir -p "$PKG/plugins/$subdir"
              cp -a "$QT_PLUGIN_DIR/$subdir/." "$PKG/plugins/$subdir/"
            fi
          done

          cat > "$PKG/bin/qt.conf" <<'EOF'
          [Paths]
          Plugins=../plugins
          EOF

          ntldd -R "$PKG/bin/tile_compile_runner.exe" | tee "$PKG/ntldd_runner.txt"
          ntldd -R "$PKG/bin/tile_compile_cli.exe" | tee "$PKG/ntldd_cli.txt"
          ntldd -R "$PKG/bin/tile_compile_gui.exe" | tee "$PKG/ntldd_gui.txt"
          ! grep -Ei "not found|missing" "$PKG/ntldd_runner.txt"
          ! grep -Ei "not found|missing" "$PKG/ntldd_cli.txt"
          ! grep -Ei "not found|missing" "$PKG/ntldd_gui.txt"

          powershell -NoProfile -Command "Compress-Archive -Path '$PKG' -DestinationPath '${PKG}.zip' -Force"

      - name: Upload package (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: tile_compile_cpp-windows-${{ steps.tag.outputs.tag }}
          path: tile_compile_cpp-windows-${{ steps.tag.outputs.tag }}.zip

  publish-release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: [build-linux-macos, build-windows]

    steps:
      - name: Resolve release tag
        id: tag
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${GITHUB_REF_NAME}"
          fi
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Show downloaded files
        run: find dist -maxdepth 3 -type f -print

      - name: Create / Update release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: tile_compile_cpp ${{ steps.tag.outputs.tag }}
          generate_release_notes: true
          files: |
            dist/**/*.zip
            dist/**/*.tar.gz
