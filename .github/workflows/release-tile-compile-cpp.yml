name: Release tile_compile_cpp Standalone

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (z.B. v1.2.3)"
        required: true
  workflow_call:
    inputs:
      tag:
        description: "Release tag (z.B. v1.2.3)"
        required: true
        type: string

permissions:
  contents: write

concurrency:
  group: release-tile-compile-cpp-${{ inputs.tag || github.event.inputs.tag || github.ref_name }}
  cancel-in-progress: false

jobs:
  meta:
    name: Resolve Release Metadata
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
    steps:
      - name: Resolve tag
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "workflow_call" ]]; then
            TAG="${{ inputs.tag }}"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${GITHUB_REF_NAME}"
          fi
          TAG="${TAG#refs/tags/}"
          if [[ -z "$TAG" ]]; then
            echo "Tag konnte nicht ermittelt werden." >&2
            exit 1
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Resolved tag: $TAG"

  package-linux:
    name: Package Linux Standalone (ubuntu-24.04)
    runs-on: ubuntu-24.04
    needs: meta
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake ninja-build pkg-config zip patchelf \
            libeigen3-dev libopencv-dev libcfitsio-dev libyaml-cpp-dev nlohmann-json3-dev libssl-dev \
            qt6-base-dev qt6-tools-dev libgl1-mesa-dev
          if [ -d /usr/lib/qt6/bin ]; then
            echo "/usr/lib/qt6/bin" >> "$GITHUB_PATH"
          fi

      - name: Build and package (release script)
        shell: bash
        run: |
          set -euo pipefail
          SKIP_DEPS=1 bash tile_compile_cpp/build_linux_release.sh

      - name: Collect artifacts
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ needs.meta.outputs.tag }}"
          mkdir -p artifacts
          SRC="tile_compile_cpp/dist/tile_compile_cpp-linux-release.zip"
          test -f "$SRC"
          cp "$SRC" "artifacts/tile_compile_cpp-linux-${TAG}.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tile_compile_cpp-linux-${{ needs.meta.outputs.tag }}
          path: artifacts/tile_compile_cpp-linux-${{ needs.meta.outputs.tag }}.zip

  package-macos:
    name: Package macOS Standalone (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: meta
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            suffix: macos14
          - os: macos-13
            suffix: macos13
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          brew update
          brew install cmake ninja pkg-config eigen opencv cfitsio yaml-cpp nlohmann-json openssl qt
          echo "$(brew --prefix qt)/bin" >> "$GITHUB_PATH"

      - name: Build and package (release script)
        shell: bash
        run: |
          set -euo pipefail
          bash tile_compile_cpp/build_macos_release.sh

      - name: Collect artifacts
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ needs.meta.outputs.tag }}"
          SUFFIX="${{ matrix.suffix }}"
          mkdir -p artifacts

          APP_BUNDLE="tile_compile_cpp/dist/macos/tile_compile_gui.app"
          if [[ -d "$APP_BUNDLE" ]]; then
            ditto -c -k --sequesterRsrc --keepParent "$APP_BUNDLE" \
              "artifacts/tile_compile_cpp-${SUFFIX}-${TAG}.zip"
          fi

          DMG="tile_compile_cpp/dist/tile_compile_cpp-macos.dmg"
          if [[ -f "$DMG" ]]; then
            cp "$DMG" "artifacts/tile_compile_cpp-${SUFFIX}-${TAG}.dmg"
          fi

          ls -la artifacts

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tile_compile_cpp-${{ matrix.suffix }}-${{ needs.meta.outputs.tag }}
          path: artifacts/*
          if-no-files-found: error

  package-windows:
    name: Package Windows Standalone (windows-2022)
    runs-on: windows-2022
    needs: meta
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSYS2 dependencies
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-pkgconf
            mingw-w64-x86_64-eigen3
            mingw-w64-x86_64-opencv
            mingw-w64-x86_64-cfitsio
            mingw-w64-x86_64-yaml-cpp
            mingw-w64-x86_64-nlohmann-json
            mingw-w64-x86_64-openssl
            mingw-w64-x86_64-qt6-base
            mingw-w64-x86_64-qt6-tools
            mingw-w64-x86_64-qt6-svg
            mingw-w64-x86_64-ntldd

      - name: Build and package (release script)
        shell: cmd
        run: |
          set PATH=C:\msys64\mingw64\bin;C:\msys64\usr\bin;%PATH%
          tile_compile_cpp\build_windows_release.bat

      - name: Collect artifacts
        shell: pwsh
        run: |
          $Tag = "${{ needs.meta.outputs.tag }}"
          New-Item -ItemType Directory -Path artifacts -Force | Out-Null
          $src = "C:\windows-tile-compile-build\dist\tile_compile_cpp-windows-release.zip"
          if (!(Test-Path $src)) {
            throw "Windows Release ZIP nicht gefunden: $src"
          }
          Copy-Item $src "artifacts\tile_compile_cpp-windows-$Tag.zip" -Force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tile_compile_cpp-windows-${{ needs.meta.outputs.tag }}
          path: artifacts/tile_compile_cpp-windows-${{ needs.meta.outputs.tag }}.zip

  publish-release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: [meta, package-linux, package-macos, package-windows]
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Show downloaded files
        shell: bash
        run: find dist -maxdepth 4 -type f -print

      - name: Generate checksums
        shell: bash
        run: |
          set -euo pipefail
          (
            cd dist
            find . -type f \( -name "*.zip" -o -name "*.tar.gz" -o -name "*.dmg" \) -print0 \
              | sort -z \
              | xargs -0 sha256sum > SHA256SUMS.txt
          )

      - name: Create / update release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.meta.outputs.tag }}
          name: tile_compile_cpp ${{ needs.meta.outputs.tag }}
          generate_release_notes: true
          files: |
            dist/**/*.zip
            dist/**/*.tar.gz
            dist/**/*.dmg
            dist/SHA256SUMS.txt
