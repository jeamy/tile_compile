$schema: "http://json-schema.org/draft-07/schema#"
title: tile_compile v3 config
type: object
properties:
  pipeline:
    type: object
    properties:
      mode: {type: string, enum: [production, test]}
      abort_on_fail: {type: boolean}
  output:
    type: object
    properties:
      registered_dir: {type: string}
      artifacts_dir: {type: string}
      write_registered_frames: {type: boolean}
      write_global_metrics: {type: boolean}
      write_global_registration: {type: boolean}
  data:
    type: object
    properties:
      image_width: {type: integer, minimum: 1}
      image_height: {type: integer, minimum: 1}
      frames_min: {type: integer, minimum: 1}
      frames_target: {type: integer, minimum: 0}
      color_mode: {type: string, enum: [OSC, MONO, RGB]}
      bayer_pattern: {type: string}
      linear_required: {type: boolean}
  linearity:
    type: object
    properties:
      enabled: {type: boolean}
      max_frames: {type: integer, minimum: 1}
      min_overall_linearity: {type: number, minimum: 0, maximum: 1}
      strictness: {type: string, enum: [strict, moderate, permissive]}
  calibration:
    type: object
    properties:
      use_bias: {type: boolean}
      use_dark: {type: boolean}
      use_flat: {type: boolean}
      bias_use_master: {type: boolean}
      dark_use_master: {type: boolean}
      flat_use_master: {type: boolean}
      dark_auto_select: {type: boolean}
      dark_match_exposure_tolerance_percent: {type: number, minimum: 0}
      dark_match_use_temp: {type: boolean}
      dark_match_temp_tolerance_c: {type: number, minimum: 0}
      bias_dir: {type: string}
      darks_dir: {type: string}
      flats_dir: {type: string}
      bias_master: {type: string}
      dark_master: {type: string}
      flat_master: {type: string}
      pattern: {type: string}
  assumptions:
    type: object
    properties:
      frames_min: {type: integer, minimum: 1}
      frames_optimal: {type: integer, minimum: 1}
      frames_reduced_threshold: {type: integer, minimum: 1}
      exposure_time_tolerance_percent: {type: number, minimum: 0}
      reduced_mode_skip_clustering: {type: boolean}
      reduced_mode_cluster_range:
        type: array
        items: {type: integer, minimum: 1}
        minItems: 2
        maxItems: 2
  normalization:
    type: object
    properties:
      enabled: {type: boolean}
      mode: {type: string, enum: [background, median]}
      per_channel: {type: boolean}
  registration:
    type: object
    properties:
      engine: {type: string, enum: [triangle_star_matching, star_similarity, hybrid_phase_ecc]}
      allow_rotation: {type: boolean}
      star_topk: {type: integer, minimum: 3}
      star_min_inliers: {type: integer, minimum: 2}
      star_inlier_tol_px: {type: number, exclusiveMinimum: 0}
      star_dist_bin_px: {type: number, exclusiveMinimum: 0}
  tile_denoise:
    type: object
    properties:
      soft_threshold:
        type: object
        properties:
          enabled: {type: boolean}
          blur_kernel: {type: integer, minimum: 3}
          alpha: {type: number, exclusiveMinimum: 0}
          skip_star_tiles: {type: boolean}
      wiener:
        type: object
        properties:
          enabled: {type: boolean}
          snr_threshold: {type: number, minimum: 0}
          q_min: {type: number, minimum: -1}
          q_max: {type: number, minimum: 0, maximum: 1}
          q_step: {type: number, exclusiveMinimum: 0}
          min_snr: {type: number, minimum: 0}
          max_iterations: {type: integer, minimum: 1}
  wiener_denoise:
    type: object
    properties:
      enabled: {type: boolean}
      snr_threshold: {type: number, minimum: 0}
      q_min: {type: number, minimum: -1}
      q_max: {type: number, minimum: 0, maximum: 1}
      q_step: {type: number, exclusiveMinimum: 0}
      min_snr: {type: number, minimum: 0}
      max_iterations: {type: integer, minimum: 1}
  global_metrics:
    type: object
    properties:
      adaptive_weights: {type: boolean}
      weight_exponent_scale:
        type: number
        exclusiveMinimum: 0
        description: "Exponent scale k for G_f = exp(k * Q_f). k=1.0 (default) is standard, k>1 increases differentiation between good/bad frames. E.g. k=1.5 gives typical ratio ~20:1, k=2.0 gives ~54:1."
      weights:
        type: object
        properties:
          background: {type: number, minimum: 0, maximum: 1}
          noise: {type: number, minimum: 0, maximum: 1}
          gradient: {type: number, minimum: 0, maximum: 1}
      clamp:
        type: array
        items: {type: number}
        minItems: 2
        maxItems: 2
  tile:
    type: object
    properties:
      size_factor: {type: integer, minimum: 1}
      min_size: {type: integer, minimum: 1}
      max_divisor: {type: integer, minimum: 1}
      overlap_fraction: {type: number, minimum: 0, maximum: 0.5}
      star_min_count: {type: integer, minimum: 0}
  local_metrics:
    type: object
    properties:
      clamp:
        type: array
        items: {type: number}
        minItems: 2
        maxItems: 2
      star_mode:
        type: object
        properties:
          weights:
            type: object
            properties:
              fwhm: {type: number, minimum: 0, maximum: 1}
              roundness: {type: number, minimum: 0, maximum: 1}
              contrast: {type: number, minimum: 0, maximum: 1}
      structure_mode:
        type: object
        properties:
          background_weight: {type: number, minimum: 0, maximum: 1}
          metric_weight: {type: number, minimum: 0, maximum: 1}
  synthetic:
    type: object
    properties:
      weighting: {type: string, enum: [global, tile_weighted]}
      frames_min: {type: integer, minimum: 1}
      frames_max: {type: integer, minimum: 1}
      clustering:
        type: object
        properties:
          mode: {type: string, enum: [kmeans, quantile]}
          cluster_count_range:
            type: array
            items: {type: integer, minimum: 1}
            minItems: 2
            maxItems: 2
  reconstruction:
    type: object
    properties:
      weighting_function: {type: string, enum: [linear]}
      window_function: {type: string, enum: [hanning]}
  debayer: {type: boolean}
  astrometry:
    type: object
    properties:
      enabled: {type: boolean}
      astap_bin: {type: string}
      astap_data_dir: {type: string}
      search_radius: {type: integer, minimum: 1, maximum: 360}
  pcc:
    type: object
    properties:
      enabled: {type: boolean}
      source: {type: string, enum: [auto, siril, vizier_gaia, vizier_apass]}
      mag_limit: {type: number, minimum: 1, maximum: 22}
      mag_bright_limit: {type: number, minimum: 0, maximum: 15}
      aperture_radius_px: {type: number, exclusiveMinimum: 0}
      annulus_inner_px: {type: number, exclusiveMinimum: 0}
      annulus_outer_px: {type: number, exclusiveMinimum: 0}
      min_stars: {type: integer, minimum: 3}
      sigma_clip: {type: number, exclusiveMinimum: 0}
      siril_catalog_dir: {type: string}
  stacking:
    type: object
    properties:
      method: {type: string, enum: [rej, average]}
      sigma_clip:
        type: object
        properties:
          sigma_low: {type: number, exclusiveMinimum: 0}
          sigma_high: {type: number, exclusiveMinimum: 0}
          max_iters: {type: integer, minimum: 1}
          min_fraction: {type: number, minimum: 0, maximum: 1}
      output_stretch: {type: boolean}
  validation:
    type: object
    properties:
      min_fwhm_improvement_percent: {type: number}
      max_background_rms_increase_percent: {type: number}
      min_tile_weight_variance: {type: number, minimum: 0}
      require_no_tile_pattern: {type: boolean}
  runtime_limits:
    type: object
    properties:
      tile_analysis_max_factor_vs_stack: {type: number, exclusiveMinimum: 0}
      hard_abort_hours: {type: number, exclusiveMinimum: 0}
