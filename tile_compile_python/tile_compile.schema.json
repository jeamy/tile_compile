{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "tile_compile.schema.json",
  "title": "tile_compile.yaml schema (Methodik v4)",
  "description": "Machine-readable JSON Schema for tile_compile.yaml. Aligned with Methodik v4 (tile-wise local registration, no global registration). Related files: tile_compile.yaml (config), tile_compile.schema.yaml (GUI metadata), tile_compile_runner.py (implementation).",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "pipeline",
    "data",
    "normalization",
    "registration",
    "global_metrics",
    "tile",
    "local_metrics",
    "synthetic",
    "reconstruction",
    "stacking",
    "validation",
    "runtime_limits"
  ],
  "properties": {
    "pipeline": {
      "type": "object",
      "additionalProperties": false,
      "required": ["mode", "abort_on_fail"],
      "properties": {
        "mode": {
          "type": "string",
          "enum": ["production", "test"]
        },
        "abort_on_fail": { "type": "boolean" }
      }
    },

    "data": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "image_width",
        "image_height",
        "frames_min",
        "color_mode",
        "linear_required"
      ],
      "properties": {
        "image_width": { "type": "integer", "minimum": 1 },
        "image_height": { "type": "integer", "minimum": 1 },
        "frames_min": { "type": "integer", "minimum": 1 },
        "frames_target": {
          "type": "integer",
          "minimum": 0,
          "default": 0,
          "description": "Optional upper bound for how many frames are used for analysis steps (0 = use all)."
        },
        "color_mode": { "type": "string", "enum": ["OSC"] },
        "bayer_pattern": {
          "type": "string",
          "enum": ["RGGB", "BGGR", "GBRG", "GRBG"],
          "default": "GBRG"
        },
        "linear_required": { "type": "boolean", "const": true }
      }
    },

    "calibration": {
      "type": "object",
      "additionalProperties": false,
      "required": ["use_bias", "use_dark", "use_flat"],
      "properties": {
        "use_bias": { "type": "boolean" },
        "use_dark": { "type": "boolean" },
        "use_flat": { "type": "boolean" },
        "bias_use_master": { "type": "boolean", "default": false },
        "dark_use_master": { "type": "boolean", "default": false },
        "flat_use_master": { "type": "boolean", "default": false },
        "dark_auto_select": {
          "type": "boolean",
          "default": true,
          "description": "If true and darks_dir contains mixed exposures/temps, auto-select a matching subset based on light frame headers before building master dark."
        },
        "dark_match_exposure_tolerance_percent": {
          "type": "number",
          "minimum": 0,
          "default": 5.0,
          "description": "Allowed exposure mismatch (percent) between lights and selected darks."
        },
        "dark_match_use_temp": {
          "type": "boolean",
          "default": false,
          "description": "If true, also match darks by CCD temperature (if available in FITS headers)."
        },
        "dark_match_temp_tolerance_c": {
          "type": "number",
          "minimum": 0,
          "default": 2.0,
          "description": "Allowed CCD temperature mismatch (C) between lights and selected darks."
        },
        "bias_dir": { "type": "string", "default": "" },
        "darks_dir": { "type": "string", "default": "" },
        "flats_dir": { "type": "string", "default": "" },
        "bias_master": { "type": "string", "default": "" },
        "dark_master": { "type": "string", "default": "" },
        "flat_master": { "type": "string", "default": "" },
        "pattern": {
          "type": "string",
          "default": "*.fit*",
          "description": "Glob pattern used to collect calibration frames from bias/darks/flats dirs."
        }
      }
    },

    "normalization": {
      "type": "object",
      "additionalProperties": false,
      "required": ["enabled", "mode", "per_channel"],
      "properties": {
        "enabled": { "type": "boolean", "const": true },
        "mode": { "type": "string", "enum": ["background", "median"] },
        "per_channel": { "type": "boolean" }
      }
    },

    "registration": {
      "type": "object",
      "description": "Methodik v4: Tile-wise Local Registration (TLR). No global registration phase.",
      "additionalProperties": false,
      "required": ["local_tiles"],
      "properties": {
        "local_tiles": {
          "type": "object",
          "description": "Tile-local registration parameters (Methodik v4 §5)",
          "additionalProperties": false,
          "required": ["model", "ecc_cc_min", "min_valid_frames"],
          "properties": {
            "model": {
              "type": "string",
              "enum": ["translation"],
              "default": "translation",
              "description": "Movement model - translation only (§5.1)"
            },
            "ecc_cc_min": {
              "type": "number",
              "minimum": 0.0,
              "maximum": 1.0,
              "default": 0.2,
              "description": "Minimum ECC correlation to accept tile registration"
            },
            "min_valid_frames": {
              "type": "integer",
              "minimum": 1,
              "default": 10,
              "description": "Minimum valid frames required per tile"
            },
            "reference_method": {
              "type": "string",
              "enum": ["median_time", "min_gradient"],
              "default": "median_time",
              "description": "Tile reference selection method"
            },
            "max_tile_size": {
              "type": "integer",
              "minimum": 32,
              "maximum": 512,
              "default": 128,
              "description": "Hard limit for tile size (§4)"
            },
            "registration_quality_beta": {
              "type": "number",
              "minimum": 0.0,
              "maximum": 20.0,
              "default": 5.0,
              "description": "Registration quality weight sensitivity β (§7)"
            },
            "max_iterations": {
              "type": "integer",
              "minimum": 1,
              "maximum": 10,
              "default": 3,
              "description": "Iterative reference refinement iterations (§5.2)"
            },
            "temporal_smoothing_window": {
              "type": "integer",
              "minimum": 5,
              "maximum": 51,
              "default": 11,
              "description": "Temporal warp smoothing window (must be odd) (§5.3)"
            },
            "temporal_smoothing_polyorder": {
              "type": "integer",
              "minimum": 1,
              "maximum": 5,
              "default": 3,
              "description": "Polynomial order for Savitzky-Golay filter"
            },
            "enable_recursive_refinement": {
              "type": "boolean",
              "default": true,
              "description": "Enable recursive tile refinement for high-variance tiles (§4)"
            },
            "refinement_variance_threshold": {
              "type": "number",
              "minimum": 0.5,
              "maximum": 20.0,
              "default": 4.0,
              "description": "Max warp variance before tile is split"
            },
            "refinement_max_depth": {
              "type": "integer",
              "minimum": 1,
              "maximum": 4,
              "default": 2,
              "description": "Maximum recursion depth for tile refinement"
            },
            "variance_window_sigma": {
              "type": "number",
              "minimum": 0.5,
              "maximum": 10.0,
              "default": 2.0,
              "description": "Scale parameter for variance-weighted overlap window ψ(var) (§9)"
            }
          }
        }
      }
    },

    "wiener_denoise": {
      "type": "object",
      "additionalProperties": false,
      "description": "Wiener filter on reconstructed tiles (after reconstruction, before overlap-add). See doc/Wiener denoise.md",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false,
          "description": "Enable Wiener filter on reconstructed tiles (linear, MSE-optimal)"
        },
        "snr_threshold": {
          "type": "number",
          "minimum": 1.0,
          "maximum": 20.0,
          "default": 5.0,
          "description": "SNR threshold - tiles with SNR >= this are not filtered"
        },
        "q_min": {
          "type": "number",
          "minimum": -3.0,
          "maximum": 0.0,
          "default": -0.5,
          "description": "Minimum structure quality - tiles with Q_struct <= this are not filtered"
        }
      }
    },

    "global_metrics": {
      "type": "object",
      "additionalProperties": false,
      "required": ["weights", "clamp"],
      "properties": {
        "weights": {
          "type": "object",
          "description": "Weights must be normalized (sum = 1.0). Enforced as a hard error by backend validation.",
          "additionalProperties": false,
          "required": ["background", "noise", "gradient"],
          "properties": {
            "background": { "type": "number", "minimum": 0, "maximum": 1 },
            "noise": { "type": "number", "minimum": 0, "maximum": 1 },
            "gradient": { "type": "number", "minimum": 0, "maximum": 1 }
          }
        },
        "clamp": {
          "type": "array",
          "minItems": 2,
          "maxItems": 2,
          "items": { "type": "number" },
          "description": "Clamp range for Q_f before exp(·). Methodik v3.1 uses [-3, +3] as normative default."
        },
        "adaptive_weights": {
          "type": "boolean",
          "default": false,
          "description": "If true, adapt α/β/γ based on metric variances per Methodik v3.1 §3.2 (variance-based weighting)."
        }
      }
    },

    "tile": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "size_factor",
        "min_size",
        "max_divisor",
        "overlap_fraction",
        "star_min_count"
      ],
      "properties": {
        "size_factor": { "type": "integer", "minimum": 1 },
        "min_size": { "type": "integer", "minimum": 1 },
        "max_divisor": { "type": "integer", "minimum": 1 },
        "overlap_fraction": { "type": "number", "minimum": 0, "maximum": 0.5 },
        "star_min_count": { "type": "integer", "minimum": 0 }
      }
    },

    "local_metrics": {
      "type": "object",
      "additionalProperties": false,
      "required": ["clamp", "star_mode", "structure_mode"],
      "properties": {
        "clamp": {
          "type": "array",
          "minItems": 2,
          "maxItems": 2,
          "items": { "type": "number" },
          "description": "Clamp range for Q_local before exp(·); Methodik v3.1 uses [-3, +3]."
        },
        "star_mode": {
          "type": "object",
          "additionalProperties": false,
          "required": ["weights"],
          "properties": {
            "weights": {
              "type": "object",
              "description": "Weights must be normalized (sum = 1.0). Enforced as a hard error by backend validation.",
              "additionalProperties": false,
              "required": ["fwhm", "roundness", "contrast"],
              "properties": {
                "fwhm": { "type": "number", "minimum": 0, "maximum": 1 },
                "roundness": { "type": "number", "minimum": 0, "maximum": 1 },
                "contrast": { "type": "number", "minimum": 0, "maximum": 1 }
              }
            }
          }
        },
        "structure_mode": {
          "type": "object",
          "additionalProperties": false,
          "required": ["background_weight", "metric_weight"],
          "properties": {
            "background_weight": {
              "type": "number",
              "minimum": 0,
              "maximum": 1,
              "description": "Together with metric_weight must sum to 1.0. Enforced as a hard error by backend validation."
            },
            "metric_weight": {
              "type": "number",
              "minimum": 0,
              "maximum": 1,
              "description": "Together with background_weight must sum to 1.0. Enforced as a hard error by backend validation."
            }
          }
        }
      }
    },

    "synthetic": {
      "type": "object",
      "additionalProperties": false,
      "required": ["frames_min", "frames_max", "clustering"],
      "properties": {
        "weighting": {
          "type": "string",
          "enum": ["global", "tile_weighted"],
          "default": "global",
          "description": "Synthetic frame weighting mode: global uses G_f,c only; tile_weighted uses W_f,t,c = G_f,c · L_f,t,c"
        },
        "frames_min": { "type": "integer", "minimum": 1 },
        "frames_max": { "type": "integer", "minimum": 1 },
        "clustering": {
          "type": "object",
          "additionalProperties": false,
          "required": ["mode", "vector"],
          "properties": {
            "mode": { "type": "string", "enum": ["state_vector"] },
            "k_selection": {
              "type": "string",
              "enum": ["silhouette_auto"],
              "description": "How k (number of clusters) is selected. Methodology expects silhouette-based automatic k selection.",
              "default": "silhouette_auto"
            },
            "cluster_count_range": {
              "type": "array",
              "minItems": 2,
              "maxItems": 2,
              "items": { "type": "integer", "minimum": 1 },
              "description": "Allowed k range for clustering. Methodology expects 15–30 clusters.",
              "default": [15, 30]
            },
            "vector": {
              "type": "array",
              "minItems": 1,
              "items": {
                "type": "string",
                "enum": [
                  "global_weight",
                  "tile_quality_mean",
                  "tile_quality_variance",
                  "background",
                  "noise"
                ]
              }
            }
          }
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "frames_min": { "type": "integer" },
              "frames_max": { "type": "integer" }
            }
          },
          "then": {
            "properties": {},
            "description": "frames_max must be >= frames_min (enforced in backend cross-field checks)."
          }
        }
      ]
    },

    "reconstruction": {
      "type": "object",
      "additionalProperties": false,
      "required": ["weighting_function", "window_function", "tile_rescale"],
      "properties": {
        "weighting_function": { "type": "string", "const": "exponential" },
        "window_function": { "type": "string", "const": "hanning" },
        "tile_rescale": {
          "type": "string",
          "const": "median_after_background_subtraction"
        }
      }
    },

    "debayer": {
      "type": "boolean",
      "default": true,
      "description": "If true, run a debayer/demosaic step after stacking and write an RGB FITS (stacked_rgb.fits)."
    },

    "stacking": {
      "type": "object",
      "additionalProperties": false,
      "required": ["method", "input_dir", "input_pattern", "output_file"],
      "properties": {
        "method": {
          "type": "string",
          "enum": ["average", "rej"],
          "default": "average",
          "description": "Stacking method: 'average' for plain linear mean; 'rej' for sigma-clipping rejection followed by linear mean."
        },
        "input_dir": { "type": "string", "minLength": 1 },
        "input_pattern": { "type": "string", "minLength": 1 },
        "output_file": { "type": "string", "minLength": 1 },
        "sigma_clip": {
          "type": "object",
          "description": "Optional sigma-clipping parameters used when stacking.method = 'rej'. If omitted, conservative defaults are used (4σ, 3 iterations, min_fraction=0.5).",
          "additionalProperties": false,
          "properties": {
            "sigma_low": {
              "type": "number",
              "minimum": 0.1,
              "maximum": 20.0,
              "default": 4.0,
              "description": "Lower sigma threshold for rejection (z < -sigma_low)."
            },
            "sigma_high": {
              "type": "number",
              "minimum": 0.1,
              "maximum": 20.0,
              "default": 4.0,
              "description": "Upper sigma threshold for rejection (z > sigma_high)."
            },
            "max_iters": {
              "type": "integer",
              "minimum": 1,
              "maximum": 10,
              "default": 3,
              "description": "Maximum sigma-clipping iterations."
            },
            "min_fraction": {
              "type": "number",
              "minimum": 0.05,
              "maximum": 1.0,
              "default": 0.5,
              "description": "Minimum fraction of frames that must remain after clipping at a pixel; otherwise fallback to the unclipped mean at that location."
            }
          }
        }
      }
    },

    "validation": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "min_fwhm_improvement_percent",
        "max_background_rms_increase_percent",
        "min_tile_weight_variance",
        "require_no_tile_pattern"
      ],
      "properties": {
        "min_fwhm_improvement_percent": { "type": "number", "minimum": 0 },
        "max_background_rms_increase_percent": { "type": "number", "minimum": 0 },
        "min_tile_weight_variance": { "type": "number", "minimum": 0 },
        "require_no_tile_pattern": { "type": "boolean" }
      }
    },

    "runtime_limits": {
      "type": "object",
      "additionalProperties": false,
      "required": ["tile_analysis_max_factor_vs_stack", "hard_abort_hours"],
      "properties": {
        "tile_analysis_max_factor_vs_stack": { "type": "number", "minimum": 0 },
        "hard_abort_hours": { "type": "number", "minimum": 0 }
      }
    },

    "v4": {
      "type": "object",
      "description": "Methodik v4 specific parameters",
      "additionalProperties": false,
      "properties": {
        "iterations": {
          "type": "integer",
          "minimum": 1,
          "maximum": 10,
          "default": 3,
          "description": "Iterative reconstruction iterations (§5.2)"
        },
        "beta": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 20.0,
          "default": 5.0,
          "description": "Registration quality weight sensitivity R_{f,t} = exp(β·(cc-1)) (§7)"
        },
        "min_valid_tile_fraction": {
          "type": "number",
          "minimum": 0.1,
          "maximum": 1.0,
          "default": 0.3,
          "description": "Minimum fraction of valid tiles required (§12)"
        },
        "adaptive_tiles": {
          "type": "object",
          "description": "Adaptive tile refinement configuration",
          "additionalProperties": false,
          "properties": {
            "enabled": {
              "type": "boolean",
              "default": false,
              "description": "Enable adaptive tile refinement based on warp variance"
            },
            "max_refine_passes": {
              "type": "integer",
              "minimum": 0,
              "maximum": 5,
              "default": 2,
              "description": "Maximum number of tile refinement passes"
            },
            "refine_variance_threshold": {
              "type": "number",
              "minimum": 0.0,
              "maximum": 10.0,
              "default": 0.25,
              "description": "Warp variance threshold for tile splitting"
            },
            "min_tile_size_px": {
              "type": "integer",
              "minimum": 32,
              "maximum": 512,
              "default": 64,
              "description": "Minimum tile size in pixels"
            }
          }
        },
        "convergence": {
          "type": "object",
          "description": "Convergence check configuration",
          "additionalProperties": false,
          "properties": {
            "enabled": {
              "type": "boolean",
              "default": false,
              "description": "Enable convergence check for early stopping"
            },
            "epsilon_rel": {
              "type": "number",
              "minimum": 1.0e-6,
              "maximum": 1.0e-1,
              "default": 1.0e-3,
              "description": "Relative L2 norm threshold for convergence"
            }
          }
        },
        "memory_limits": {
          "type": "object",
          "description": "Memory usage limits",
          "additionalProperties": false,
          "properties": {
            "rss_warn_mb": {
              "type": "integer",
              "minimum": 512,
              "default": 4096,
              "description": "Soft memory limit (MB) - warning only"
            },
            "rss_abort_mb": {
              "type": "integer",
              "minimum": 1024,
              "default": 8192,
              "description": "Hard memory limit (MB) - abort run if exceeded"
            }
          }
        },
        "diagnostics": {
          "type": "object",
          "description": "Diagnostic artifact generation",
          "additionalProperties": false,
          "properties": {
            "enabled": {
              "type": "boolean",
              "default": true,
              "description": "Enable diagnostic artifact generation"
            },
            "warp_field": {
              "type": "boolean",
              "default": true,
              "description": "Save warp vector field per channel"
            },
            "tile_invalid_map": {
              "type": "boolean",
              "default": true,
              "description": "Save map of invalid tiles"
            },
            "warp_variance_hist": {
              "type": "boolean",
              "default": true,
              "description": "Save histogram of warp variances"
            }
          }
        }
      }
    },

    "assumptions": {
      "type": "object",
      "description": "Methodik v4 assumption tolerances and reduced mode configuration",
      "additionalProperties": false,
      "properties": {
        "frames_min": {
          "type": "integer",
          "minimum": 1,
          "default": 50,
          "description": "Hard minimum frame count. Below this: abort."
        },
        "frames_optimal": {
          "type": "integer",
          "minimum": 1,
          "default": 800,
          "description": "Optimal frame count for full methodology."
        },
        "frames_reduced_threshold": {
          "type": "integer",
          "minimum": 1,
          "default": 200,
          "description": "Below this (but above frames_min): reduced mode."
        },
        "exposure_time_tolerance_percent": {
          "type": "number",
          "minimum": 0,
          "maximum": 100,
          "default": 5,
          "description": "Maximum allowed deviation in exposure time."
        },
        "warp_variance_warn": {
          "type": "number",
          "minimum": 0,
          "default": 2.0,
          "description": "Warp variance threshold for warning (v4)."
        },
        "warp_variance_max": {
          "type": "number",
          "minimum": 0,
          "default": 8.0,
          "description": "Maximum allowed warp variance per tile. Above this: tile marked invalid (v4)."
        },
        "elongation_warn": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "default": 0.3,
          "description": "Star elongation threshold for warning."
        },
        "elongation_max": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "default": 0.4,
          "description": "Maximum allowed star elongation. Above this: abort."
        },
        "tracking_error_max_px": {
          "type": "number",
          "minimum": 0,
          "default": 1.0,
          "description": "Maximum allowed tracking error per exposure in pixels (implicit assumption from Methodik v3 §1.3)."
        },
        "reduced_mode_cluster_range": {
          "type": "array",
          "minItems": 2,
          "maxItems": 2,
          "items": { "type": "integer", "minimum": 1 },
          "default": [5, 10],
          "description": "Cluster count range for reduced mode."
        },
        "reduced_mode_skip_clustering": {
          "type": "boolean",
          "default": true,
          "description": "Skip state clustering in reduced mode."
        }
      }
    },

    "linearity": {
      "type": "object",
      "description": "Optional linearity validation gate for Methodik v3.1 (§2.1/§4). If omitted, no automatic linearity check is performed.",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false,
          "description": "Enable linearity validation during SCAN_INPUT."
        },
        "max_frames": {
          "type": "integer",
          "minimum": 1,
          "default": 8,
          "description": "Maximum number of frames sampled for linearity validation."
        },
        "min_overall_linearity": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "default": 0.9,
          "description": "Minimum required overall linearity score (0–1). Below this threshold, the run aborts in SCAN_INPUT."
        },
        "strictness": {
          "type": "string",
          "enum": ["strict", "moderate", "permissive"],
          "default": "strict",
          "description": "Strictness setting passed to the backend linearity validator."
        }
      }
    }
  }
}
